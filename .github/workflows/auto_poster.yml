name: Auto Poster System v5.2 - ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ

on:
  schedule:
    # --- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¨ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ (UTC+4) ---
    # ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ (UTC+4)
    # Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ© (ØªØ¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø© 9:30 Ø¨ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ)
    - cron: '30 5 * * *'   # Ø§Ù„Ù†Ø´Ø± 1 (9:30 Ø¯Ø¨ÙŠ = 5:30 UTC)
    - cron: '0 6 * * *'    # Ø§Ù„Ù†Ø´Ø± 2 (10:00 Ø¯Ø¨ÙŠ = 6:00 UTC)
    - cron: '45 6 * * *'   # Ø§Ù„Ù†Ø´Ø± 3 (10:45 Ø¯Ø¨ÙŠ = 6:45 UTC)
    
    # Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¸Ù‡Ø±ÙŠØ© (ØªØ¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø© 13:30 Ø¨ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ)
    - cron: '30 9 * * *'   # Ø§Ù„Ù†Ø´Ø± 1 (13:30 Ø¯Ø¨ÙŠ = 9:30 UTC)
    - cron: '0 10 * * *'   # Ø§Ù„Ù†Ø´Ø± 2 (14:00 Ø¯Ø¨ÙŠ = 10:00 UTC)
    - cron: '45 10 * * *'  # Ø§Ù„Ù†Ø´Ø± 3 (14:45 Ø¯Ø¨ÙŠ = 10:45 UTC)
    
    # Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ© (ØªØ¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø© 18:30 Ø¨ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ)
    - cron: '30 14 * * *'  # Ø§Ù„Ù†Ø´Ø± 1 (18:30 Ø¯Ø¨ÙŠ = 14:30 UTC)
    - cron: '0 15 * * *'   # Ø§Ù„Ù†Ø´Ø± 2 (19:00 Ø¯Ø¨ÙŠ = 15:00 UTC)
    - cron: '45 15 * * *'  # Ø§Ù„Ù†Ø´Ø± 3 (19:45 Ø¯Ø¨ÙŠ = 15:45 UTC)
    
    # Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù„ÙŠÙ„ÙŠØ© (ØªØ¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø© 22:30 Ø¨ØªÙˆÙ‚ÙŠØª Ø¯Ø¨ÙŠ)
    - cron: '30 18 * * *'  # Ø§Ù„Ù†Ø´Ø± 1 (22:30 Ø¯Ø¨ÙŠ = 18:30 UTC)
    - cron: '0 19 * * *'   # Ø§Ù„Ù†Ø´Ø± 2 (23:00 Ø¯Ø¨ÙŠ = 19:00 UTC)
    - cron: '45 19 * * *'  # Ø§Ù„Ù†Ø´Ø± 3 (23:45 Ø¯Ø¨ÙŠ = 19:45 UTC)
  workflow_dispatch: {}     # Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  # ===================================================================
  # JOB 1: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
  # ===================================================================
  install-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          echo "Cache not found. Installing dependencies..."
          npm install --omit=dev --prefer-offline --no-audit --no-fund

  # ===================================================================
  # JOB 2: Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§ÙˆØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ (ÙŠØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
  # ===================================================================
  setup_daily_rotation:
    runs-on: ubuntu-latest
    needs: install-dependencies
    # Ø§Ù„Ø´Ø±Ø· Ø§Ù„ØªØ§Ù„ÙŠ ÙŠØ¶Ù…Ù† ØªØ´ØºÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ Ø£ÙˆÙ„ Ø¬Ø¯ÙˆÙ„Ø© (5:30 UTC)
    if: github.event.schedule == '30 5 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download dependencies from cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      
      - name: Run Daily Zapier Rotation Setup
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          ZAPIER_WEBHOOKS: ${{ secrets.ZAPIER_WEBHOOKS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: node src/setup_rotation.js
        timeout-minutes: 5

  # ===================================================================
  # JOB 3: ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø´Ø± (ÙŠØ¹Ù…Ù„ 12 Ù…Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…)
  # ===================================================================
  process-post:
    runs-on: ubuntu-latest
    needs: [install-dependencies, setup_daily_rotation]
    # Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… ØªØ®Ø·ÙŠ 'setup_daily_rotation'
    if: always() 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download dependencies from cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Run Auto Poster
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          ZAPIER_WEBHOOKS: ${{ secrets.ZAPIER_WEBHOOKS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸš€ Starting Auto Poster System..."
          node src/auto_poster.js
        timeout-minutes: 10
